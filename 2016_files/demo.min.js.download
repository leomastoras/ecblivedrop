(function() {

	function getLinkClass(link) {
		switch (link.split('.').pop()) {
		case 'epub':
			return 'epub';
			break;
		case 'doc':
		case 'docx':
			return 'doc';
			break;
		case 'pdf':
			return 'pdf';
			break;
		case 'xls':
		case 'xlsx':
			return 'xls';
			break;
		case 'csv':
			return 'csv';
			break;
		case 'zip':
			return 'download';
			break;
		default:
			try {
				url = new URL(link);
				switch (url.protocol) {
				case 'mailto:':
					return 'mail';
					break;
				case 'tel:':
					return 'telephone'
					break;
				default:
					switch (url.hostname) {
					case 'www.facebook.com':
					case 'facebook.com':
					case 'fb.me':
						return 'facebook';
						break;
					case 'www.linkedin.com':
					case 'linkedin.com':
						return 'linkedin';
						break;
					case 'www.flickr.com':
					case 'flickr.com':
						return 'flickr';
						break;
					case 'www.twitter.com':
					case 'twitter.com':
						return 'twitter';
						break;
					case 'www.google-plus.com':
					case 'google-plus.com':
						return 'google-plus';
						break;
					case 'www.youtube.com':
					case 'youtube.com':
					case 'youtu.be':
						return 'youtube';
						break;
					default:
						return 'external';
					}
				}
			} catch (e) {
				return null;
			}
		}
	}

	$.extend({
		replaceTag : function(currentElem, newTagObj, keepProps) {
			var $currentElem = $(currentElem);
			var i,
				$newTag = $(newTagObj).clone();
			if (keepProps) {
				newTag = $newTag[0];
				newTag.className = currentElem.className;
				$.extend(newTag.classList, currentElem.classList);
				$.extend(newTag.attributes, currentElem.attributes);
			}
			$currentElem.wrapAll($newTag);
			$currentElem.contents().unwrap();
			return this;
		}
	});

	(function($) {
		$.fn.changeElementType = function(newType) {
			this.each(function() {
				var attrs = {};

				$.each(this.attributes, function(idx, attr) {
					attrs[attr.nodeName] = attr.nodeValue;
				});

				$(this).replaceWith(function() {
					return $("<" + newType + "/>", attrs).append($(this).contents());
				});
			});
		};
	})(jQuery);

	$.fn.extend({
		replaceTag : function(newTagObj, keepProps) {
			return this.each(function() {
				jQuery.replaceTag(this, newTagObj, keepProps);
			});
		}
	});

	function readFileInputEventAsArrayBuffer(event, callback) {
		var file = event.target.files[0];

		var reader = new FileReader();

		reader.onload = function(loadEvent) {
			var arrayBuffer = loadEvent.target.result;
			callback(arrayBuffer);
		};

		reader.readAsArrayBuffer(file);
	}

	function handleFileSelectD(evt) {
		evt.stopPropagation();
		evt.preventDefault();

		var files = evt.dataTransfer.files;

		file = files[0];

		var reader = new FileReader();

		reader.onload = function(loadEvent) {
			var arrayBuffer = loadEvent.target.result;
			mammoth.convertToHtml({
				arrayBuffer : arrayBuffer
			}, {
				transformDocument : function(element) {
					console.log(element);
					return element;
				},
				styleMap : [ 'p.Date => div.ecb-pressContentPubDate', 'p.DocumentType => div.ecb-pressCategory',
					'p.Title => h1.ecb-pressContentTitle', 'p.Subtitle => h2.ecb-pressContentSubtitle',
					'p.Heading1 => h2:fresh', 'p.Heading2 => h3:fresh', 'p.Heading3 => h4:fresh',
					'p.ListBullet => ul > li:fresh', 'p.ListNumber => ol > li:fresh' ]
			}).then(function(html) {

				$('#drop_zone').html('<div class="ecb-pressContent"><article>' + html.value + '</article></div>');

				$('#drop_zone').find('h1.ecb-pressContentTitle').after($('#drop_zone').find('div.ecb-pressContentPubDate'));

				// Link Classes
				$('#drop_zone').find('a').not('sup a').each(function() {
					$(this).attr('href') && $(this).addClass(getLinkClass($(this).attr('href')));
				});

				//Tables
				$('#drop_zone').find('table').addClass('ecb-contentTable');
				let pre = $('#drop_zone').find('table tr:first').html();
				$('#drop_zone').find('table tr:first').remove();
				$('#drop_zone').find('table').prepend($('<thead><tr>'+pre.replace(/td/g,'th')+'</tr></thead>'));
				$('#drop_zone').find('table td').each(function() {
					let c = [...$(this).text()].pop();
					if ('âˆ’0123456789'.indexOf(c) !== -1) {
						$(this).addClass('number')
					}
				});

				// Footnotes
				if ($('#drop_zone').find('article').children().last().is('ol')) {
					$('#drop_zone').find('sup > sup').unwrap('<sup></sup>');
					$('#drop_zone').find('sup > a[id^=footnote-ref]').each(function(idx) {
						footId = parseInt($(this).html().match(/\d+/));
						footId = idx + 1;
						$(this).attr('href', '#footnote.' + -~idx);
						$(this).attr('id', 'fn' + footId);
						$(this).html(footId);
						$(this).before('[');
						$(this).after(']');
					});
					$('#drop_zone').find('ol').last().replaceTag('<div class="footnotes">');
					$('#drop_zone').find('.footnotes li p a:last-child').remove();
					$('#drop_zone').find('.footnotes > li > p').each(
						function(idx) {
							$(this).html(
								'<sup>[<a id="footnote.' + -~idx + '" href="#' + -~idx + '">' + -~idx
								+ '</a>]</sup>' + $(this).html());
						});
					$('#drop_zone').find('.footnotes').before('<br><hr>');
					$('#drop_zone').find('.footnotes li').replaceTag('<div class="footnote">').attr('id', '');
				}

				//Add footer
				$('#drop_zone').removeClass('dropBoxBg');
				$('#drop_zone article').after('<div class="footer footer-address"><address><strong>European Central Bank</strong><br>Directorate General Communications <br>Sonnemannstrasse 20, 60314 Frankfurt am Main, Germany <br>Tel.: +49 69 1344 7455, E-mail: <a href="mailto:media@ecb.europa.eu" class="email2">media@ecb.europa.eu</a><br> Website: <a href="http://www.ecb.europa.eu">www.ecb.europa.eu</a></address><p class="disclaimer">Reproduction is permitted provided that the source is acknowledged.</p></div><p> <a class="arrow" href="/press/contacts/html/index.en.html">Media contacts</a> </p>');

				/**/
				$('article ul li, article p:lt(5)').textillate({
					in : {
						effect : 'fadeInDown',
						shuffle : true,
						delay : 2,
						delayScale : 1
					},
					type : 'word'
				});
				$('article h1, article h2').textillate({
					in : {
						effect : 'fadeInDown',
						shuffle : true,
						delay : 2,
						delayScale : 1
					}
				});
				/*$('#dropzone ul:nth-child(1) li').textillate({ in: {effect: 'fadeInDown', shuffle: true}});
				$('#dropzone p:nth-child(1)').textillate({ in: {effect: 'fadeInDown', shuffle: true}});*/


				//Enable footnotes
				ECB.footnotes();
			});

		};
		reader.readAsArrayBuffer(file);
	}

	function handleDragOver(evt) {
		evt.stopPropagation();
		evt.preventDefault();
		evt.dataTransfer.dropEffect = 'copy';
	}

	var dropZone = document.getElementById('drop_zone');
	dropZone.addEventListener('dragover', handleDragOver, false);
	dropZone.addEventListener('drop', handleFileSelectD, false);

})();